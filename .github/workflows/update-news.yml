name: Update News Content

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  update-news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Create news update script
        run: |
          cat << 'EOF' > update-news.js
          const fs = require('fs');
          const axios = require('axios');
          const cheerio = require('cheerio');

          (async () => {
            try {
              // Fetch HK01 homepage
              const { data } = await axios.get('https://www.hk01.com', {
                headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)' }
              });
              
              // Parse HTML
              const $ = cheerio.load(data);
              const article = $('a[data-test="article-item"]').first();
              const title = article.text().trim() || 'Latest news update';
              const url = article.attr('href') || '/';
              
              console.log(`üìå Parsed title: ${title}`);
              
              // Get current timestamp
              const now = new Date();
              const timestamp = now.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
              }).replace(/‚Äé/g, ''); // Clean bidirectional marks
              
              // Read index.html
              let content = fs.readFileSync('index.html', 'utf8');
              
              // Update news link
              const newsLinkRegex = /(<a [^>]*class="news-link">)[^<]*(</a>)/;
              content = content.replace(newsLinkRegex, `$1${title}$2`);
              
              // Update timestamp
              const timestampRegex = /(<p class="small">)Selected.*(<\/p>)/;
              content = content.replace(timestampRegex, `$1Updated: ${timestamp} | Selected from HK01$2`);
              
              // Save changes
              fs.writeFileSync('index.html', content);
              console.log('‚úÖ News section updated successfully');
              
            } catch (error) {
              console.error('‚ùå Failed to update news:', error.message);
              process.exit(1);
            }
          })();
          EOF

      - name: Install dependencies
        run: npm install axios cheerio

      - name: Run news update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node update-news.js
          
          # Commit changes if index.html was modified
          if git diff --quiet index.html; then
            echo "‚ÑπÔ∏è No changes needed"
          else
            git config --global user.email "action@github.com"
            git config --global user.name "GitHub Actions"
            git commit -am "üì∞ News updated via Node.js" && git push origin main
          fi