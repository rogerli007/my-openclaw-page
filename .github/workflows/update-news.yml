name: Update News Content

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  update-news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install HTML parser (with GitHub API)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get release asset URL using GitHub API
          echo "üîç Getting official download URL via GitHub API..."
          
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "‚ö†Ô∏è GITHUB_TOKEN is missing - using direct URL"
            ASSET_URL='https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.tar.gz'
          else
            echo "‚úÖ Found GITHUB_TOKEN"
            ASSET_URL=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/ericchiang/pup/releases/tags/v0.4.0" | \
              jq -r '.assets[] | select(.name == "pup_v0.4.0_linux_amd64.tar.gz") | .browser_download_url')
          fi
          
          # Download the binary
          curl -L -H "Authorization: token $GITHUB_TOKEN" \
            -o pup.tar.gz "$ASSET_URL"
          
          # Verify download
          if [ $? -ne 0 ] || [ ! -s pup.tar.gz ]; then
            echo "‚ùå Download failed! First 50 bytes:"
            head -c 50 pup.tar.gz | xxd
            exit 1
          fi
          
          # Check file type
          FILETYPE=$(file pup.tar.gz)
          if echo "$FILETYPE" | grep -q "gzip"; then
            tar xzf pup.tar.gz
            chmod +x pup
            sudo mv pup /usr/local/bin/
            echo "‚úÖ pup installed successfully!"
          else
            echo "‚ùå Invalid file type: $FILETYPE"
            exit 1
          fi

      - name: Fetch and update news
        run: |
          echo "‚è∞ Workflow started at: $(date)"
          
          # Get top news URL
          URL=$(curl -s 'https://www.hk01.com' | grep -Po 'a\s+data-test="article-item" href="\K/[^" ]+' | head -1)
          if [ -z "$URL" ]; then
            URL="/"
          fi
          
          # Get title with maximum fallbacks
          TITLE=$(curl -s "https://www.hk01.com$URL" | grep -Po '<h1\s+class="article-title">\K[^<]+' | head -1)
          if [ -z "$TITLE" ]; then
            TITLE=$(curl -s "https://www.hk01.com$URL" | grep -Po '<title>\K[^<]+(?=</title>)' | head -1)
          fi
          if [ -z "$TITLE" ]; then
            TITLE="News update"
          fi
          
          # Clean title
          TITLE="$(echo $TITLE | sed 's/[^[:print:]]//g')"
          echo "üìã Parsed title: $TITLE"
          
          # Update content
          sed -i -E "s|(<a [^>]*class=\"news-link\">)[^<]*(</a>)|\1$TITLE\2|" index.html
          sed -i -E "s|(<p class=\"small\">)Selected.*</p>|\1Updated: $(date '+%Y-%m-%d %H:%M') | Selected from HK01</p>|" index.html
          
          # Commit if changes
          if ! git diff --quiet; then
            git config --global user.email "action@github.com"
            git config --global user.name "GitHub Actions"
            git commit -am "üì∞ News updated: $TITLE" && git push origin main
          else
            echo "‚ÑπÔ∏è No changes needed"
          fi